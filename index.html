<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Financeiro</title>
  <link rel="stylesheet" href="estilo.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <aside class="sidebar">
    <h2>📊 Financeiro</h2>
    <nav>
      <a href="index.html" class="active">🏠 Dashboard</a>
      <a href="compras.html">🛒 Compras</a>
      <a href="vendas.html">💰 Vendas</a>
      <a href="clientes.html">👤 Clientes</a>
      <a href="fornecedores.html">🏭 Fornecedores</a>
      <a href="estoque.html">📦 Estoque</a>
      <a href="contas-receber-simples.html">📥 Contas a Receber</a>
      <a href="contas-pagar.html">📤 Contas a Pagar</a>
    </nav>
  </aside>

  <main class="main">
    <div class="title">Resumo Financeiro</div>

    <div class="cards">
      <div class="card">
        <h3>Total de Vendas</h3>
        <div class="value" id="totalVendas">R$ 0,00</div>
      </div>
      <div class="card">
        <h3>Total Recebido</h3>
        <div class="value" id="totalRecebido">R$ 0,00</div>
      </div>
      <div class="card">
        <h3>Contas a Pagar</h3>
        <div class="value" id="contasPagar">R$ 0,00</div>
      </div>
    </div>

    <div class="charts">
      <div class="chart-box">
        <h4>Vendas por Cliente</h4>
        <canvas id="vendasClientes"></canvas>
      </div>
      <div class="chart-box">
        <h4>Contas a Receber e Pagar</h4>
        <canvas id="receberPagar"></canvas>
      </div>
    </div>
  </main>

  <script>
    const vendas = JSON.parse(localStorage.getItem('vendas')) || [];
    const contasPagar = JSON.parse(localStorage.getItem('contasPagar')) || [];

    function formatar(valor) {
      return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function calcularResumo() {
      let totalVendas = 0;
      let totalRecebido = 0;
      const vendasPorCliente = {};

      vendas.forEach(venda => {
        const valorTotal = parseFloat(venda.valor) * parseInt(venda.quantidade);
        totalVendas += valorTotal;

        if (venda.pagamento === 'avista' && venda.status === 'recebido') {
          totalRecebido += valorTotal;
        } else if (venda.pagamento === 'aprazo' && venda.parcelasDetalhes) {
          venda.parcelasDetalhes.forEach(parcela => {
            if (parcela.status === 'recebido') {
              totalRecebido += parcela.valor;
            }
          });
        }

        if (venda.cliente) {
          vendasPorCliente[venda.cliente] = (vendasPorCliente[venda.cliente] || 0) + valorTotal;
        }
      });

      const totalAPagar = contasPagar
        .filter(cp => cp.status === 'em aberto')
        .reduce((acc, curr) => acc + Number(curr.valor || 0), 0);

      document.getElementById('totalVendas').innerText = formatar(totalVendas);
      document.getElementById('totalRecebido').innerText = formatar(totalRecebido);
      document.getElementById('contasPagar').innerText = formatar(totalAPagar);

      return { vendasPorCliente };
    }

    const { vendasPorCliente } = calcularResumo();

    new Chart(document.getElementById('vendasClientes'), {
      type: 'bar',
      data: {
        labels: Object.keys(vendasPorCliente),
        datasets: [{
          label: 'Vendas (R$)',
          data: Object.values(vendasPorCliente),
          backgroundColor: '#40E0D0'
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });

    function agruparPorMes(array, tipo = 'receber') {
      const resultado = {};
      array.forEach(item => {
        if (tipo === 'receber' && item.pagamento === 'aprazo') {
          item.parcelasDetalhes?.forEach(parcela => {
            const mes = parcela.vencimento?.slice(0, 7);
            if (parcela.status === 'em aberto' && mes) {
              resultado[mes] = (resultado[mes] || 0) + parcela.valor;
            }
          });
        } else if (tipo === 'pagar' && item.status === 'em aberto') {
          const mes = item.data?.slice(0, 7);
          resultado[mes] = (resultado[mes] || 0) + parseFloat(item.valor);
        }
      });
      return resultado;
    }

    const receberMensal = agruparPorMes(vendas, 'receber');
    const pagarMensal = agruparPorMes(contasPagar, 'pagar');
    const meses = [...new Set([...Object.keys(receberMensal), ...Object.keys(pagarMensal)])].sort();

    new Chart(document.getElementById('receberPagar'), {
      type: 'line',
      data: {
        labels: meses,
        datasets: [
          {
            label: 'A Receber',
            data: meses.map(m => receberMensal[m] || 0),
            borderColor: '#20B2AA',
            backgroundColor: 'rgba(32,178,170,0.1)',
            fill: true,
            tension: 0.4
          },
          {
            label: 'A Pagar',
            data: meses.map(m => pagarMensal[m] || 0),
            borderColor: '#008B8B',
            backgroundColor: 'rgba(0,139,139,0.1)',
            fill: true,
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'top' } },
        scales: { y: { beginAtZero: true } }
      }
    });
  </script>

</body>
</html>
