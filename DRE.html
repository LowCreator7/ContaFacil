<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>DRE - Demonstrativo de Resultado</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    * {
      margin: 0; padding: 0; box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    body {
      display: flex;
      background: #f4f6fa;
      color: #2f4f4f;
      min-height: 100vh;
    }

    .sidebar {
      width: 220px;
      background: #111827;
      color: #fff;
      padding: 30px 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .sidebar h2 {
      font-size: 20px;
      margin-bottom: 30px;
    }

    .sidebar a {
      color: #cbd5e1;
      text-decoration: none;
      padding: 10px 15px;
      border-radius: 8px;
      display: block;
      transition: 0.3s;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background: #1e293b;
      color: #fff;
    }

    .main {
      flex: 1;
      padding: 30px;
    }

    h2 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 26px;
      color: #008080;
    }

    .filtros {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    select {
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }

    th, td {
      padding: 12px 10px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #e0f7fa;
      color: #2f4f4f;
      font-weight: 600;
    }

    .total {
      font-weight: bold;
      background: #f5f5f5;
    }
  </style>
</head>
<body>

  <aside class="sidebar">
    <h2>üìä DRE</h2>
    <nav>
      <a href="dashboard.html">üè† Dashboard</a>
      <a href="compras.html">üõí Compras</a>
      <a href="vendas.html">üí∞ Vendas</a>
      <a href="clientes.html">üë§ Clientes</a>
      <a href="fornecedores.html">üè≠ Fornecedores</a>
      <a href="contas-receber.html">üì• Contas a Receber</a>
      <a href="contas-pagar.html">üì§ Contas a Pagar</a>
      <a href="estoque.html">üì¶ Estoque</a>
      <a href="dre.html" class="active">üìà DRE</a>
    </nav>
  </aside>

  <main class="main">
    <h2>DRE - Demonstrativo de Resultado</h2>

    <div class="filtros">
      <select id="mesFiltro">
        <option value="">Selecione o m√™s</option>
        ${[...Array(12).keys()].map(i => {
          const m = (i + 1).toString().padStart(2, '0');
          return `<option value="${m}">${m}</option>`;
        }).join('')}
      </select>
      <select id="anoFiltro"></select>
    </div>

    <table>
      <thead><tr><th>Resumo</th><th>Valor (R$)</th></tr></thead>
      <tbody id="resumoDRE"></tbody>
    </table>

    <table>
      <thead><tr><th>Despesas Detalhadas</th><th>Valor</th></tr></thead>
      <tbody id="despesasAnaliticas"></tbody>
    </table>

  </main>

  <script>
    const mesFiltro = document.getElementById('mesFiltro');
    const anoFiltro = document.getElementById('anoFiltro');
    const resumoDRE = document.getElementById('resumoDRE');
    const despesasAnaliticas = document.getElementById('despesasAnaliticas');

    const vendas = JSON.parse(localStorage.getItem('vendas')) || [];
    const compras = JSON.parse(localStorage.getItem('compras')) || [];
    const despesas = JSON.parse(localStorage.getItem('despesas')) || [];

    function preencherAnos() {
      const anos = new Set([
        ...vendas.map(v => new Date(v.data).getFullYear()),
        ...compras.map(c => new Date(c.data).getFullYear()),
        ...despesas.map(d => new Date(d.data).getFullYear())
      ]);
      anoFiltro.innerHTML = '<option value="">Selecione o ano</option>';
      [...anos].sort().forEach(ano => {
        const opt = document.createElement('option');
        opt.value = ano;
        opt.textContent = ano;
        anoFiltro.appendChild(opt);
      });
    }

    function filtrarPorMesAno(lista, campoData) {
      const mes = mesFiltro.value;
      const ano = anoFiltro.value;
      return lista.filter(item => {
        const data = new Date(item[campoData]);
        return data.getMonth() + 1 === parseInt(mes) && data.getFullYear() === parseInt(ano);
      });
    }

    function calcularCMV(ano, mes) {
      const mesNum = parseInt(mes);
      const estoqueAtual = {};
      const estoqueAnterior = {};

      const comprasAnteriores = compras.filter(c => {
        const data = new Date(c.data);
        return (
          data.getFullYear() < parseInt(ano) ||
          (data.getFullYear() === parseInt(ano) && data.getMonth() + 1 < mesNum)
        );
      });

      const vendasAnteriores = vendas.filter(v => {
        const data = new Date(v.data);
        return (
          data.getFullYear() < parseInt(ano) ||
          (data.getFullYear() === parseInt(ano) && data.getMonth() + 1 < mesNum)
        );
      });

      comprasAnteriores.forEach(c => {
        estoqueAnterior[c.produto] = (estoqueAnterior[c.produto] || 0) + parseInt(c.quantidade);
      });
      vendasAnteriores.forEach(v => {
        estoqueAnterior[v.produto] = (estoqueAnterior[v.produto] || 0) - parseInt(v.quantidade);
      });

      const comprasAtuais = filtrarPorMesAno(compras, 'data');
      const vendasAtuais = filtrarPorMesAno(vendas, 'data');

      comprasAtuais.forEach(c => {
        estoqueAtual[c.produto] = (estoqueAtual[c.produto] || 0) + parseInt(c.quantidade);
      });
      vendasAtuais.forEach(v => {
        estoqueAtual[v.produto] = (estoqueAtual[v.produto] || 0) - parseInt(v.quantidade);
      });

      let estoqueIni = 0;
      for (const produto in estoqueAnterior) {
        const c = comprasAnteriores.find(x => x.produto === produto);
        const valor = c ? parseFloat(c.valor) : 0;
        estoqueIni += (estoqueAnterior[produto] || 0) * valor;
      }

      let comprasMes = 0;
      comprasAtuais.forEach(c => {
        comprasMes += parseFloat(c.valor) * parseInt(c.quantidade);
      });

      let estoqueFim = 0;
      for (const produto in estoqueAtual) {
        const c = comprasAtuais.find(x => x.produto === produto);
        const valor = c ? parseFloat(c.valor) : 0;
        estoqueFim += (estoqueAnterior[produto] || 0) * valor + (estoqueAtual[produto] || 0) * valor;
      }

      return estoqueIni + comprasMes - estoqueFim;
    }

    function renderizarDRE() {
      const mes = mesFiltro.value;
      const ano = anoFiltro.value;
      if (!mes || !ano) return;

      const vendasMes = filtrarPorMesAno(vendas, 'data');
      const despesasMes = filtrarPorMesAno(despesas, 'data');

      const receita = vendasMes.reduce((acc, v) => acc + (v.valor * v.quantidade), 0);
      const despesasTotal = despesasMes.reduce((acc, d) => acc + parseFloat(d.valor), 0);
      const cmv = calcularCMV(ano, mes);
      const lucroBruto = receita - cmv;
      const lucroLiquido = lucroBruto - despesasTotal;

      resumoDRE.innerHTML = `
        <tr><td>Receita Bruta</td><td>R$ ${receita.toFixed(2)}</td></tr>
        <tr><td>CMV (Estoque Inicial + Compras - Estoque Final)</td><td>R$ ${cmv.toFixed(2)}</td></tr>
        <tr><td>Lucro Bruto</td><td>R$ ${lucroBruto.toFixed(2)}</td></tr>
        <tr><td>Total de Despesas</td><td>R$ ${despesasTotal.toFixed(2)}</td></tr>
        <tr class="total"><td>Lucro L√≠quido</td><td>R$ ${lucroLiquido.toFixed(2)}</td></tr>
      `;

      despesasAnaliticas.innerHTML = '';
      despesasMes.forEach(d => {
        despesasAnaliticas.innerHTML += `<tr><td>${d.descricao}</td><td>R$ ${parseFloat(d.valor).toFixed(2)}</td></tr>`;
      });
    }

    mesFiltro.addEventListener('change', renderizarDRE);
    anoFiltro.addEventListener('change', renderizarDRE);

    preencherAnos();
  </script>
</body>
</html>
